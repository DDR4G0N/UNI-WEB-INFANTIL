import{auth,db}from'./firebase-config.js';import{onAuthStateChanged,updatePassword,deleteUser,signOut}from"https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";document.addEventListener('DOMContentLoaded',function(){var t=document.getElementById('logoutBtnPerfil');t&&t.addEventListener('click',function(){signOut(auth).then(()=>{window.location.href='index.html'}).catch(t=>{alert('Error al cerrar sesi√≥n: '+t.message)})})});import{doc as e,getDoc as n,deleteDoc as a}from"https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";let r=null,o=null;function i(t){const e=new Date,n=new Date(t),a=e.getFullYear()-n.getFullYear(),r=e.getMonth()-n.getMonth();return r<0||0===r&&e.getDate()<n.getDate()?a-1:a}function d(t){const e=new Date(t);return e.toLocaleDateString('es-ES',{year:'numeric',month:'long',day:'numeric'})}async function c(t){try{const c=e(db,"users",t),u=await n(c);if(u.exists())return u.data();throw new Error("No se encontraron datos del usuario")}catch(t){throw console.error("Error al obtener datos del usuario:",t),t}}function u(t,e){document.getElementById('perfilName').textContent=e.username||t.displayName||'Usuario',document.getElementById('perfilEmail').textContent=t.email;const n=document.getElementById('perfilAvatar'),a=(e.username||t.email).charAt(0).toUpperCase();let r=document.getElementById('avatarInicial');r||(r=document.createElement('span'),r.id='avatarInicial',r.style.zIndex='1',r.style.position='relative',n.prepend(r)),r.textContent=a,r.style.display='',n.style.backgroundImage='',document.getElementById('perfilInfoUsername').textContent=e.username||'No especificado',document.getElementById('perfilInfoEmail').textContent=t.email,document.getElementById('perfilInfoBirthdate').textContent=e.birthdate?d(e.birthdate):'No especificado',document.getElementById('perfilInfoAge').textContent=e.birthdate?`${i(e.birthdate)} a√±os`:'No especificado',document.getElementById('perfilInfoJoinDate').textContent=e.createdAt?d(e.createdAt):'No disponible',document.getElementById('perfilInfoLastLogin').textContent=t.metadata&&t.metadata.lastSignInTime?d(t.metadata.lastSignInTime):'Ahora'}async function s(){try{document.getElementById('perfilLoadingSection').style.display='block',document.getElementById('perfilProfileContent').style.display='none',document.getElementById('perfilErrorSection').style.display='none';if(!r)throw new Error("No hay usuario autenticado");o=await c(r.uid),u(r,o),document.getElementById('perfilLoadingSection').style.display='none',document.getElementById('perfilProfileContent').style.display='block'}catch(t){console.error("Error cargando perfil:",t),document.getElementById('perfilLoadingSection').style.display='none',document.getElementById('perfilErrorSection').style.display='block',document.getElementById('perfilErrorText').textContent=t.message}}window.goBack=function(){document.referrer?window.history.back():window.location.href='index.html'},window.retryLoad=function(){s()},window.editProfile=function(){alert('üöß Funci√≥n de editar perfil en desarrollo')},window.changePassword=function(){const t=prompt('Ingresa tu nueva contrase√±a (m√≠nimo 6 caracteres):');t&&t.length>=6?updatePassword(r,t).then(()=>{alert('‚úÖ Contrase√±a actualizada correctamente')}).catch(t=>{alert('‚ùå Error al cambiar contrase√±a: '+t.message)}):t&&alert('‚ùå La contrase√±a debe tener al menos 6 caracteres')},window.downloadData=function(){if(o&&r){const t={username:o.username,email:r.email,birthdate:o.birthdate,createdAt:o.createdAt,uid:r.uid},e=new Blob([JSON.stringify(t,null,2)],{type:'application/json'}),n=URL.createObjectURL(e),a=document.createElement('a');a.href=n,a.download=`perfil_${o.username||'usuario'}.json`,a.click(),URL.revokeObjectURL(n)}},window.confirmDeleteAccount=function(){if(confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar tu cuenta?\n\nEsta acci√≥n NO se puede deshacer y perder√°s todos tus datos.\n\nEscribe "ELIMINAR" para confirmar:')){const t=prompt('Escribe "ELIMINAR" para confirmar:');"ELIMINAR"===t&&l()}};async function l(){try{await a(e(db,"users",r.uid)),await deleteUser(r),alert('‚úÖ Cuenta eliminada correctamente'),window.location.href='index.html'}catch(t){console.error("Error eliminando cuenta:",t),alert('‚ùå Error al eliminar cuenta: '+t.message)}}onAuthStateChanged(auth,t=>{t?(r=t,s()):(alert('‚ùå Debes iniciar sesi√≥n para ver tu perfil'),window.location.href='index.html')});
